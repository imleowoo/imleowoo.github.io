---
title: 记一次使用路由器给大学实验室搭建FTP服务器经历
date: 2021-10-22 00:22:23
tags:
---

## 使用环境

> 路由器：联想新路由NEWIFI D1
>
> 固件：`Padavan-20170910`



## 缘由

写这篇博客的原因主要是给我所在的大学实验室路由器写一个配置参考文档。

因为是作为实验室公共使用，有不少不太懂配置的学弟学妹恐怕操作起来有些困难。而我马上就要走出学校开始工作了，这些设备以后的主要还是他们使用。

其实我所在的实验室在去年已经进购了一台DELL的服务器，但是只能放在学校内网中，没有办法托管服务，所以就之前给装了一个Windows Sever 2012，然后在实验室中闲置，偶尔当作一台普通电脑主机在进行使用。对于这种暴殄天物的行为，个人是感到很痛心的。

另外实验室还有很多资源需要存储的，比如说一些视频教程、专业软件、操作系统镜像、电路图、原理图、代码等数据。为了更好的共享资源，很有必要搭建一个FTP服务器。刚才说到暴殄天物，然而要是用上面说的那个DELL服务器用来搭建一个简单的FTP服务器，那又岂不是大材小用呢？

所以不如选用低成本的智能路由器搭建一个简单的FTP服务器吧。

## 预期功能

根据现有的需求，预期需要实现三个功能：

1. FTP文件服务器，实现文件共享；
2. 打印机服务，实现打印机共享；
3. 路由直接接入校园网，方便实验室人员直接访问校园内网。

### FTP服务器

#### 关于FTP

维基百科的解释是：文件传输协议（英文：`File Transfer Protocol`，缩写：`FTP`）是用于在网络上进行文件传输的一套标准协议，使用客户/服务器模式。它属于网络传输协议的应用层。

百度百科的解释是：`FTP` 是`File Transfer Protocol`（文件传输协议）。用于Internet上的控制文件的双向传输。同时，它也是一个应用程序（Application）。基于不同的操作系统有不同的FTP应用程序，而所有这些应用程序都遵守同一种协议以传输文件。在FTP的使用当中，用户经常遇到两个概念："下载"（Download）和"上传"（Upload）。"下载"文件就是从远程主机拷贝文件至自己的计算机上；"上传"文件就是将文件从自己的计算机中拷贝至远程主机上。用Internet语言来说，用户可通过客户机程序向（从）远程主机上传（下载）文件。

#### 实验室服务器需要实现的具体功能

##### 文件资源共享

1. 在该路由器提供的局域网内（访问内网IP-`192.168.*.*/24`），即在实验室内可以访问存储资源；
2. 在路由器所在的校园局域网内（访问`172.*.*.*/16`），即在整个校园内，只要访问设备接入校园网均可实现访问；
3. 对于一些资源，如视频文件实现网络串流，直接在线播放视频教程，无需下载存储的视频资源；
4. 允许匿名登录服务器，并查看资源，但不能更改或删除相关数据。仅有admin用户或root用户可以进行管理；
5. 利用samba进行用户管理，允许存在的用户访问自己的私有的文件或目录。

##### 打印机服务共享

1. 将打印机接入路由器实现打印机共享；
2. 允许所在路由器所提供的局域网内共享，而不允许校园网所在局域网内的用户访问。

##### 接入校园网

1. 路由器作为客户端接入校园网，认证后可供该路由器所提供局域网内所有设备免认证上网。

## 准备工作

### 硬盘

#### 硬盘分区

新购买的硬盘是未进行分区的，我们可以按照自己的需求来进行分区，除了分区容量以外，另外一些分区参数也应该值得注意，如分区表类型、文件系统、对齐方式等等。

**开始分区**

> 操作环境：Windows10 RS2、DiskGenius（分区精灵）

将硬盘放入硬盘盒上电后，接入到电脑USB口。打开刚才的下载的DiskGenius软件进行分区工作。如果正常的话，硬盘列表中会显示除你硬盘以外另外一块增加的硬盘，具体的分区步骤以及分区参数可以参照下图。

![硬盘分区操作步骤](/Users/leowoo/Projects/imleowoo.github.io/source/images/ftp-disk-genius.png)

等待格式化完成后，应该是如下的状态：

![硬盘分区结束](/Users/leowoo/Projects/imleowoo.github.io/source/images/ftp-disk-genius-done.png)

#### 硬盘分区注意事项

1. **为什么分区类型选用MBR？**

   对比MBR和GUID两种分区类型。简单来说就是MBR是传统的分区类型，但是意味着通用性更加强。比如说现在操作份额占用最大的Windows 7 对GUID分区类型也不算完全兼容。

   所以我们这儿这样分只是为了保证最大的兼容性。不过值得注意的是MBR的分区类型最大只支持2TB硬盘，如果购买的应该容量是大于2TB的话，还是应该选用GUID分区类型，不过还好现在这块硬盘容量刚好2TB。

2. **分区的盘符名称命名**

   我们用这块硬盘作为资源存储盘，所接入的服务器是Linux操作系统，说详细一点就是路由器所运行的嵌入式Linux系统（下面会说到）。

   该系统只保留了一些十分精简的功能，以至于对于一些字符的支持不太友好，这里面就包括中文字符。所以如果我们使用中文字符命名分区的话，可能会显示出乱码。这种情况在Windows以及非精简的Linux中更少见一些。

3. **文件系统格式**

   关于这次分区选用的是NTFS格式的文件系统。

   值得一提的是，NTFS的文件系统对于早期的Linux操作系统和苹果家的MacOS并不算太友好。Windows上我们可见的盘符通常是使用FAT32和NTFS，Linux上使用的除了FAT以外，还有EXT2、EXT3、EXT4等，要说为了保证通用性，还是选用FAT32最好。但是FAT32的文件系统不支持超过4GB的单个文件存储，实验室一个常用的大型软件如MATLAB就已经是6、7GB以上了，所以自然还是抛弃了FAT32。

   亲测该路由作为服务器支持NTFS的硬盘挂载，所以选用了NTFS分区的文件系统。

### 路由器

#### 路由器的选购

1. **智能路由器的个人理解**

   之前对智能路由器的关注度不高，在路由选购方面也主要是看够用、稳定这两个条件即可。

   我首先接触到的是，自从极路由发布第一代第二代智能路由，并成一代路由刷机神器之后，我开始对智能路由产生兴趣。

   **智能路由的理解**，我觉得可以类比以前普通手机和智能手机吧。现在的智能手机除了满足普通手机的通话、短信功能以外，还统一了操作平台（Android、iOS、WindowsPhone），应用软件的通用性大大的拓展了智能手机的实用性、可玩性。所以智能路由器亦是如此，所统一的平台是嵌入式的Linux操作系统。虽然几乎所有智能路由器都是基于Linux定制，但是不同的系统也会存在较大的差异，除了官方自己定制的系统以外，第三方也有很多固件可供选择，如`OpenWRT`、`DD-WRT`、`Tomato`等等第三方开源固件。所以我们可以根据自己的功能需求，刷入第三方固件来实现。从而可以实现例如ADBLOCK广告屏蔽、远程下载、私人云、aria2下载等功能。

   所以为满足我们功能的拓展，通过第三方固件的刷入，所以应该选择主流的路由器（主流包括主流的路由型号、芯片型号如`MT7620\MT7621`这些，因为固件对芯片和ROM这些硬件还是挺挑的）。

2. **路由参数**

   最终选购的路由器是NEWIFI-D1，这是百度与联想合作的第二代路由。下面是关于NEWIFI-D1的一些参数（芯片为MT7621）

   ![newifi-d1参数](/Users/leowoo/Projects/imleowoo.github.io/source/images/ftp-newifi-d1-specification.png)

3. **选购原因**

   1. 预算：这款路由刚推出时售价299，现在220左右可以买到；
   - 性能：芯片相比于上一代的MT7620升级到MT7621，性能直逼千元级的华硕、网件等路由；
   - 接口：实验室位置固定的原因，访问该路由多是使用无线网络，所以网线接口显得不太重要，一共三个接口都是千兆1Gbps的。USB口有两个，因为需要接入硬盘USB、还有一个打印机，一共需要两个USB接口（其中USB3.0口默认被禁用）。所以无需使用USB HUB进行拓展接口，相比于多数单USB口的路由更具有优势。
   - 资源：第三方固件适配多、迅速。

#### 刷入第三方固件



